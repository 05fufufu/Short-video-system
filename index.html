<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”æ³•å°‘å¥³çš„è§†é¢‘ç½‘ç«™ - vedio</title>
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

    <style>
        :root {
            --magic-pink: #ff758c; --magic-blue: #8aa9ff;
            --glass-bg: rgba(255, 255, 255, 0.75); --text-title: #2c3e50;
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; min-height: 100vh;
            background-image: url('./mm.jpg'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat;
            transition: background-image 0.5s ease;
        }
        a { text-decoration: none; color: inherit; }

        /* === å¯¼èˆªæ  === */
        .navbar {
            background: rgba(255, 255, 255, 0.5); border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px);
        }
        .logo { font-family: 'Ma Shan Zheng', cursive; font-size: 32px; cursor: pointer; background: linear-gradient(45deg, #ff758c, #ff7eb3); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 2px rgba(255, 255, 255, 0.8)); }
        
        .main-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* === é¦–é¡µç½‘æ ¼ === */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .video-card { background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 16px; overflow: hidden; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow-soft); border: 1px solid rgba(255,255,255,0.6); }
        .video-card:hover { transform: translateY(-8px); background: rgba(255,255,255,0.9); }
        .card-cover { width: 100%; aspect-ratio: 16 / 9; background: #eee; overflow: hidden; }
        .card-cover img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 14px; }
     /* å¼ºåˆ¶ç©ºçŠ¶æ€æç¤ºæ–‡å­—æ˜¾ç¤ºä¸ºæ·±è‰²ä¸”åŠ ç²— */
.el-empty__description p {
    color: var(--text-title) !important;
    font-weight: bold !important;
    font-size: 18px !important;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.8); /* å¢åŠ ç™½è‰²æè¾¹é˜²æ­¢çœ‹ä¸æ¸… */
}

.empty-wrap {
    padding-top: 100px;
    width: 100%;
    display: flex;
    justify-content: center;
}
        /* === è¯¦æƒ…é¡µå‚ç›´å¸ƒå±€ === */
        .detail-layout { max-width: 1000px; margin: 0 auto; }
        .video-player-box { width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .video-player-box video { width: 100%; height: 100%; }
        
        .video-header { margin: 25px 0; }
        .video-header h1 { font-family: 'ZCOOL KuaiLe', cursive; font-size: 32px; color: var(--text-title); margin-bottom: 10px; }

        /* å‘å¸ƒè€…ä¿¡æ¯æ  */
        .uploader-card { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; }
        .uploader-avatar { border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .uploader-name { font-family: 'ZCOOL KuaiLe'; font-size: 20px; color: var(--magic-pink); }

        .action-bar { display: flex; gap: 15px; margin-top: 15px; }
        .action-btn { display: flex; align-items: center; cursor: pointer; background: rgba(255,255,255,0.8); padding: 10px 25px; border-radius: 12px; border: 1px solid #fff; transition: 0.3s; font-weight: bold; }
        .action-btn.active { background: linear-gradient(to right, #ff9a9e, #fad0c4); color: #fff; border: none; }
        .delete-btn { color: #f56c6c; background: rgba(245, 108, 108, 0.1); }

        .glass-panel { background: var(--glass-bg); padding: 30px; border-radius: 16px; backdrop-filter: blur(10px); box-shadow: var(--shadow-soft); margin-bottom: 50px; }

        /* è¯„è®ºå¤´åƒ */
        .comment-avatar { border: 1.5px solid var(--magic-blue); }

        /* æŠ•ç¨¿é¡µï¼š16:9 + é€€å‡º */
        .upload-container { max-width: 700px; margin: 40px auto; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(25px); padding: 50px; border-radius: 24px; position: relative; box-shadow: var(--shadow-soft); }
        .cover-upload-box { width: 100%; aspect-ratio: 16 / 9; border-radius: 12px; border: 2px dashed #ff758c; background-size: cover; background-position: center; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.4); overflow: hidden; }
        .close-icon { position: absolute; top: 25px; right: 25px; font-size: 28px; color: #888; cursor: pointer; z-index: 10; transition: 0.3s; border-radius: 50%; padding: 5px; }

        /* æ¢è‚¤çƒ */
        .theme-fab { position: fixed; bottom: 40px; right: 40px; width: 60px; height: 60px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 999; box-shadow: 0 5px 20px rgba(0,0,0,0.15); transition: 0.4s; border: 2px solid #f0f0f0; }

        .auth-dialog .el-dialog { border-radius: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); }
    </style>
</head>
<body>
<div id="app">
    <nav class="navbar">
        <div class="logo" @click="goHome">é­”æ³•å°‘å¥³çš„è§†é¢‘ç½‘ç«™</div>
        <div style="flex:1; max-width:400px; margin:0 20px;">
            <el-input v-model="searchKw" placeholder="æœç´¢é­”æ³•å½±åƒ..." @keyup.enter="doSearch">
                <template #append><el-button icon="Search" @click="doSearch"></el-button></template>
            </el-input>
        </div>
        <div class="nav-right">
            <template v-if="!isLoggedIn"><el-button round @click="showAuth = true">ç™»å½• / æ³¨å†Œ</el-button></template>
            <template v-else>
                <el-button round color="#ff758c" style="color:white; font-weight:bold;" @click="goUpload"><el-icon><Camera-Filled /></el-icon> æ–½æ³•æŠ•ç¨¿</el-button>
                <el-button round color="#8aa9ff" style="color:white; font-weight:bold; margin-left:10px" @click="goNoteUpload"><el-icon><Edit-Pen /></el-icon> å‘å¸ƒç¬”è®°</el-button>
                <el-dropdown @command="hCmd" style="margin-left:15px">
                    <el-avatar :size="40" style="border:2px solid var(--magic-pink)" :src="myInfo.avatar"></el-avatar>
                    <template #dropdown><el-dropdown-menu>
                        <el-dropdown-item command="goProfile" icon="User">ä¸ªäººä¸»é¡µ</el-dropdown-item>
                        <el-dropdown-item command="changeAvatar" icon="Picture">æ›´æ¢é­”æ³•å¤´åƒ</el-dropdown-item>
                        <el-dropdown-item command="logout" divided icon="Close">æ³¨é”€å¥‘çº¦</el-dropdown-item>
                    </el-dropdown-menu></template>
                </el-dropdown>
            </template>
        </div>
    </nav>

    <div class="main-container"><router-view :key="$route.fullPath"></router-view></div>

    <input type="file" id="avatarInput" style="display:none" accept="image/*" @change="uploadAvatar">
    <input type="file" id="bgInput" style="display:none" @change="cBg">
    <div class="theme-fab" @click="tBg"><el-icon :size="28" color="#8aa9ff"><Picture-Filled /></el-icon></div>

    <el-dialog v-model="showAuth" title="é­”æ³•å¥‘çº¦" width="380px" center>
        <el-form label-position="top">
            <el-form-item label="é­”æ³•ä»£å·"><el-input v-model="authF.username"></el-input></el-form-item>
            <el-form-item label="æ ¡éªŒå£ä»¤"><el-input v-model="authF.password" type="password" show-password></el-input></el-form-item>
            <el-button type="primary" @click="doA" style="width:100%; background:#ff758c; border:none; font-weight:bold;">{{ authF.isLogin ? 'è¿›å…¥ä½é¢' : 'å®Œæˆå¥‘çº¦' }}</el-button>
            <p style="text-align:center; font-size:12px; color:#888; cursor:pointer; margin-top:15px;" @click="authF.isLogin = !authF.isLogin">{{ authF.isLogin ? 'è¿˜æ²¡æœ‰ä»£å·ï¼Ÿå»æ³¨å†Œ' : 'å·²æœ‰ä»£å·ï¼Ÿå»ç™»å½•' }}</p>
        </el-form>
    </el-dialog>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
<script src="https://unpkg.com/element-plus"></script>
<script src="https://unpkg.com/@element-plus/icons-vue"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/hls.js/dist/hls.min.js"></script>

<script>
    const { createApp, ref, reactive, onMounted, watch } = Vue;
    const { createRouter, createWebHashHistory, useRouter, useRoute } = VueRouter;
    
    // ğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šç•™ç©ºå³å¯è‡ªåŠ¨é€‚é…å½“å‰åŸŸå (æ— è®ºæ˜¯ localhostã€IP è¿˜æ˜¯ cpolar)
    const API_BASE = ''; 
    
    const Home = {
        template: `
            <div v-loading="loading">
                <!-- åªæœ‰æœ‰æ•°æ®æ—¶æ‰æ˜¾ç¤ºç½‘æ ¼ -->
                <div v-if="list && list.length > 0" class="video-grid">
                    <div class="video-card" v-for="item in list" :key="item.id" @click="goDetail(item)">
                        <div class="card-cover">
                            <img :src="item.cover_url || 'https://via.placeholder.com/320x180/eef2ff/8aa9ff?text=Magic'">
                            <div style="position:absolute; bottom:8px; right:8px; background:rgba(255,255,255,0.9); color:#ff758c; padding:2px 8px; font-size:12px; border-radius:10px; font-weight:bold;">HD</div>
                        </div>
                        <div class="card-info">
                            <div class="card-title">{{ item.title }}</div>
                            <div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">
                                <span>é­”æ³•ä½¿ ID: {{ item.author_id }}</span>
                                <span>{{ formatDate(item.created_at) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸŒŸ æ ¸å¿ƒï¼šæ”¹è¿›åçš„ç©ºçŠ¶æ€æ˜¾ç¤º -->
                <div v-else-if="!loading" class="empty-wrap">
                    <el-empty description="é­”åŠ›æš‚æ—¶æ¯ç«­ï¼Œå¿«å»æŠ•ç¨¿å§" :image-size="250"></el-empty>
                </div>
            </div>
        `,
        setup() {
            const list = ref([]); 
            const loading = ref(false); 
            const router = useRouter();
            const route = useRoute();

            const fetch = async () => { 
                loading.value = true; 
                try { 
                    let url = API_BASE+'/feed';
                    const uid = localStorage.getItem('user_id');
                    if (uid) url += '?user_id=' + uid;

                    if (route.query.keyword) {
                        url = API_BASE+'/search?keyword=' + route.query.keyword;
                        if (uid) url += '&user_id=' + uid;
                    }
                    const res = await axios.get(url); 
                    list.value = res.data.video_list || []; 
                } catch(e){
                    console.error("åŠ è½½å¤±è´¥", e);
                } finally { 
                    loading.value = false; 
                } 
            };

            const formatDate = (s) => new Date(s).toLocaleDateString();
            
            // ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œå®ç°æœç´¢
            watch(() => route.query.keyword, fetch);
            onMounted(fetch); 
            
            // æ— é™æ»šåŠ¨é€»è¾‘
            const handleScroll = () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½æ›´å¤šé€»è¾‘
                    // ç›®å‰åç«¯æ¥å£æš‚æœªæ”¯æŒåˆ†é¡µå‚æ•°ï¼Œåç»­å¯æ‰©å±•
                }
            };
            onMounted(() => window.addEventListener('scroll', handleScroll));
            
            return { 
                list, loading, formatDate, 
                goDetail: (v) => {
                    if (v.type === 'note') {
                        router.push({ name: 'note', params: { id: v.id }, query: v });
                    } else {
                        router.push({ name: 'video', params: { id: v.id }, query: v });
                    }
                }
            };
        }
    };

    // ================= NoteDetail ç¬”è®°è¯¦æƒ…é¡µ =================
    const NoteDetail = {
        template: `
            <div class="detail-layout">
                <div class="glass-panel" style="padding:0; overflow:hidden; margin-bottom:20px; background:rgba(0,0,0,0.05);">
                    <el-carousel height="500px" v-if="images.length > 0" :interval="5000" arrow="always">
                        <el-carousel-item v-for="img in images" :key="img">
                            <img :src="img" style="width:100%; height:100%; object-fit:contain; backdrop-filter:blur(10px);">
                        </el-carousel-item>
                    </el-carousel>
                    <div v-else style="height:200px; display:flex; align-items:center; justify-content:center; color:#888;">æ— å›¾ç‰‡</div>
                </div>
                
                <div class="video-header">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                        <el-button circle icon="ArrowLeft" @click="$router.back()" title="è¿”å›ä¸Šä¸€é¡µ"></el-button>
                        <el-button round icon="HomeFilled" @click="$router.push('/')">å›åˆ°é¦–é¡µ</el-button>
                    </div>
                    <h1 class="video-title-big"><el-tag type="success" style="margin-right:10px; vertical-align:middle">ç¬”è®°</el-tag>{{ info.title }}</h1>
                    
                    <div class="uploader-card">
                        <el-avatar :size="60" class="uploader-avatar" :src="upInfo.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                        <div class="uploader-detail" style="margin-left:15px">
                            <div class="uploader-name">{{ upInfo.nickname || 'ç¥ç§˜é­”æ³•ä½¿' }}</div>
                            <div class="uploader-id">
                                <span>å‘å¸ƒäº: {{ formatDate(info.created_at) }}</span>
                            </div>
                        </div>
                        
                        <!-- äº’åŠ¨æŒ‰é’®ç»„ -->
                        <div class="action-bar" style="margin:0 0 0 20px">
                            <div class="action-btn" :class="{active: isLiked}" @click="toggleLike">
                                <el-icon size="20"><Pointer /></el-icon>
                                <span style="margin-left:8px">{{ isLiked ? 'å·²ç‚¹èµ' : 'ç‚¹èµ' }}</span>
                            </div>
                        </div>

                        <div v-if="isAuthor" style="margin-left:auto; cursor:pointer; color:#f56c6c; display:flex; align-items:center; background:rgba(245,108,108,0.1); padding:8px 15px; border-radius:20px;" @click="doDel">
                            <el-icon size="18"><Delete /></el-icon> <span style="margin-left:5px; font-size:14px; font-weight:bold">åˆ é™¤ç¬”è®°</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel">
                    <div style="white-space: pre-wrap; font-size: 18px; line-height: 1.8; color:#333;">{{ info.content }}</div>
                </div>

                <!-- è¯„è®ºåŒº -->
                <div class="glass-panel">
                    <h3 style="margin-top:0; font-family:'ZCOOL KuaiLe'; font-size:24px;">é­”æ³•ç•™è¨€æ¿ ({{ comments.length }})</h3>
                    
                    <div style="display:flex; gap:15px; margin:25px 0;">
                        <el-avatar :size="45" :src="currentAccountAvatar"></el-avatar>
                        <div style="flex:1">
                            <el-input v-model="cmtText" type="textarea" :rows="2" placeholder="è¾“å…¥ä½ çš„å’’è¯­è¯„è®º..." maxlength="200" show-word-limit></el-input>
                            <div style="text-align:right; margin-top:10px;">
                                <el-button type="primary" @click="postCmt" color="#ff758c" style="font-weight:bold; color:white; padding:0 30px;">æ–½æ³•</el-button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comment-list">
                        <div v-for="c in comments" :key="c.id" style="display:flex; gap:15px; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.05)">
                            <el-avatar :size="45" style="border:1px solid #eee" :src="c.user_avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                            <div style="flex:1">
                                <div style="color:var(--magic-blue); font-weight:bold; font-size:15px; margin-bottom:5px;">
                                    {{ c.user_nickname || 'é­”æ³•å­¦å¾’' }}
                                    <el-tag v-if="c.user_id == info.user_id" size="small" type="danger" style="margin-left:10px; zoom:0.8">å‘å¸ƒè€…</el-tag>
                                </div>
                                <div style="color:#333; font-size:16px; line-height:1.6">{{ c.content }}</div>
                                <div style="color:#aaa; font-size:12px; margin-top:10px;">{{ c.create_date }}</div>
                            </div>
                        </div>
                        <div v-if="comments.length === 0" style="text-align:center; color:#999; padding:60px;">
                            <el-icon size="40" style="opacity:0.3"><ChatDotRound /></el-icon>
                            <p>è¿˜æ²¡æœ‰äººç•™ä¸‹å’’è¯­ï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</p>
                        </div>
                    </div>
                </div>
            </div>
        `,
        setup() {
            const route = useRoute();
            const router = useRouter();
            const info = reactive(route.query);
            const images = ref([]);
            const upInfo = ref({});
            const comments = ref([]);
            const cmtText = ref('');
            const isLiked = ref(info.is_favorite === 'true' || info.is_favorite === true);
            
            const currentUID = localStorage.getItem('user_id');
            const currentAccountAvatar = ref('https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png');
            // æ³¨æ„ï¼šinfo.user_id å¯èƒ½æ˜¯ stringï¼ŒcurrentUID ä¹Ÿæ˜¯ stringï¼Œæ¯”è¾ƒæ—¶æœ€å¥½ç»Ÿä¸€
            const isAuthor = ref(currentUID && info.user_id && currentUID.toString() === info.user_id.toString());

            try {
                images.value = JSON.parse(info.images || '[]');
            } catch(e) { console.error(e); }

            const fetchCmt = async () => {
                try {
                    const res = await axios.get(`${API_BASE}/comment/list?note_id=${info.id}`);
                    if (res.data.status_code === 0) {
                        comments.value = res.data.comment_list || [];
                    }
                } catch(e) { console.error("åŠ è½½è¯„è®ºå¤±è´¥", e); }
            };

            const postCmt = async () => {
                if(!cmtText.value.trim()) return ElementPlus.ElMessage.warning('å’’è¯­ä¸èƒ½ä¸ºç©º');
                if(!currentUID) return ElementPlus.ElMessage.error('è¯·å…ˆç­¾è®¢å¥‘çº¦ï¼ˆç™»å½•ï¼‰');

                try {
                    const url = `${API_BASE}/comment/action?note_id=${info.id}&comment_text=${encodeURIComponent(cmtText.value)}&user_id=${currentUID}&action_type=1`;
                    const res = await axios.post(url);
                    if(res.data.status_code === 0) {
                        cmtText.value = '';
                        fetchCmt();
                        ElementPlus.ElMessage.success('å’’è¯­å·²ä¼ è¾¾ï¼');
                    }
                } catch(e) { ElementPlus.ElMessage.error('æ–½æ³•ä¸­æ–­ï¼ˆå‘é€å¤±è´¥ï¼‰'); }
            };

            const toggleLike = async () => {
                if(!currentUID) return ElementPlus.ElMessage.error('è¯·å…ˆç™»å½•');
                const action = isLiked.value ? 2 : 1;
                try {
                    await axios.post(`${API_BASE}/favorite/action?note_id=${info.id}&user_id=${currentUID}&action_type=${action}`);
                    isLiked.value = !isLiked.value;
                    ElementPlus.ElMessage.success(isLiked.value ? 'ç‚¹èµæˆåŠŸ' : 'å–æ¶ˆç‚¹èµ');
                } catch(e) {}
            };

            const doDel = () => {
                ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¬”è®°å—ï¼Ÿ', 'è­¦å‘Š', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    try {
                        const res = await axios.post(`${API_BASE}/note/delete?note_id=${info.id}`);
                        if(res.data.status_code === 0) {
                            ElementPlus.ElMessage.success('ç¬”è®°å·²åˆ é™¤');
                            router.push('/');
                        } else {
                            ElementPlus.ElMessage.error('åˆ é™¤å¤±è´¥: ' + res.data.status_msg);
                        }
                    } catch(e) { ElementPlus.ElMessage.error('åˆ é™¤å¤±è´¥'); }
                }).catch(() => {});
            };

            onMounted(() => {
                // ç¬”è®°åˆ—è¡¨è¿”å›çš„æ˜¯ user_id è€Œä¸æ˜¯ author_idï¼Œè¿™é‡Œåšä¸ªå…¼å®¹
                const uid = info.user_id || info.author_id;
                if(uid) {
                    axios.get(API_BASE+'/user/info?user_id='+uid).then(res => {
                        if(res.data.status_code === 0) upInfo.value = res.data.user;
                    });
                }
                if(currentUID) {
                    axios.get(`${API_BASE}/user/info?user_id=${currentUID}`).then(res => {
                        if(res.data.status_code === 0) currentAccountAvatar.value = res.data.user.avatar;
                    });
                    // æ£€æŸ¥ç‚¹èµçŠ¶æ€
                    axios.get(`${API_BASE}/favorite/status?note_id=${info.id}&user_id=${currentUID}`).then(res => {
                        if(res.data.status_code === 0) isLiked.value = res.data.is_favorite;
                    });
                }
                fetchCmt();
            });

            return { info, images, upInfo, isAuthor, comments, cmtText, isLiked, currentAccountAvatar, postCmt, toggleLike, doDel, formatDate: (s) => s ? new Date(s).toLocaleString() : '' };
        }
    };

    // ================= VideoDetail è¯¦æƒ…é¡µç»„ä»¶ (å¤§å±å‚ç›´å¸ƒå±€ + è¯„è®ºåŒæ­¥ç‰ˆ) =================
    const VideoDetail = {
        template: `
            <div class="detail-layout" v-loading="loading">
                <!-- 1. è§†é¢‘æ’­æ”¾å™¨åŒºåŸŸ -->
                <div class="video-player-box" style="position:relative">
                    <video ref="vPlayer" controls autoplay style="width:100%; height:100%; object-fit: contain;"></video>
                    <!-- æ¸…æ™°åº¦åˆ‡æ¢æŒ‰é’® -->
                    <div v-if="levels.length > 0" style="position:absolute; top:20px; right:20px; z-index:100;">
                        <el-dropdown @command="changeQuality">
                            <el-button type="primary" size="small" round color="rgba(0,0,0,0.6)" style="color:white; border:1px solid rgba(255,255,255,0.3)">
                                {{ currentLevelName }} <el-icon class="el-icon--right"><Arrow-Down /></el-icon>
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item v-for="l in levels" :key="l.index" :command="l.index" :style="{color: currentLevel===l.index ? '#ff758c' : ''}">
                                        {{ l.name }}
                                    </el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>
                </div>
                
                <!-- 2. è§†é¢‘ä¿¡æ¯ä¸å‘å¸ƒè€…èµ„æ–™ -->
                <div class="video-header">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
                        <el-button circle icon="ArrowLeft" @click="$router.back()" title="è¿”å›ä¸Šä¸€é¡µ"></el-button>
                        <el-button round icon="HomeFilled" @click="$router.push('/')">å›åˆ°é¦–é¡µ</el-button>
                    </div>
                    <h1 class="video-title-big">{{ videoInfo.title }}</h1>
                    
                    <div class="uploader-card">
                        <!-- å‘å¸ƒè€…å¤§å¤´åƒ -->
                        <el-avatar :size="60" class="uploader-avatar" :src="upInfo.avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                        <div class="uploader-detail">
                            <div class="uploader-name">{{ upInfo.nickname || 'æ­£åœ¨å’å”±åç§°çš„é­”æ³•ä½¿...' }}</div>
                            <div class="uploader-id">
                                <el-tag size="small" effect="plain" type="danger" style="margin-right:10px">UID: {{ videoInfo.author_id }}</el-tag>
                                <span>å¬å”¤äº: {{ formatDate(videoInfo.created_at) }}</span>
                            </div>
                        </div>
                        
                        <!-- äº¤äº’æŒ‰é’®ç»„ -->
                        <div class="action-bar" style="margin:0">
                            <div class="action-btn" :class="{active: isLiked}" @click="toggleLike">
                                <el-icon size="20"><Pointer /></el-icon>
                                <span style="margin-left:8px">{{ isLiked ? 'å¥‘çº¦å·²ç­¾è®¢' : 'ç­¾è®¢ç‚¹èµå¥‘çº¦' }}</span>
                            </div>
                            <!-- æ’¤å›æŒ‰é’®ï¼šä»…ä½œè€…å¯è§ -->
                            <div v-if="isAuthor" class="action-btn delete-btn" @click="doDel" style="margin-left:10px">
                                <el-icon size="20"><Delete /></el-icon>
                                <span style="margin-left:8px">æ’¤å›å½±åƒ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. é­”æ³•ç•™è¨€æ¿ (è¯„è®ºåŒº) -->
                <div class="glass-panel">
                    <h3 style="margin-top:0; font-family:'ZCOOL KuaiLe'; font-size:24px;">é­”æ³•ç•™è¨€æ¿ ({{ comments.length }})</h3>
                    
                    <!-- è¯„è®ºå‘é€æ¡† -->
                    <div style="display:flex; gap:15px; margin:25px 0;">
                        <el-avatar :size="45" :src="currentAccountAvatar"></el-avatar>
                        <div style="flex:1">
                            <el-input 
                                v-model="cmtText" 
                                type="textarea" 
                                :rows="2" 
                                placeholder="è¾“å…¥ä½ çš„å’’è¯­è¯„è®º..."
                                maxlength="200"
                                show-word-limit
                            ></el-input>
                            <div style="text-align:right; margin-top:10px;">
                                <el-button type="primary" @click="postCmt" color="#ff758c" style="font-weight:bold; color:white; padding:0 30px;">æ–½æ³•</el-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯„è®ºåˆ—è¡¨ -->
                    <div class="comment-list">
                        <div v-for="c in comments" :key="c.id" style="display:flex; gap:15px; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.05)">
                            <!-- ğŸŒŸ åŒæ­¥æ˜¾ç¤ºè¯„è®ºè€…çš„çœŸå®å¤´åƒ -->
                            <el-avatar :size="45" style="border:1px solid #eee" :src="c.user_avatar || 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                            <div style="flex:1">
                                <!-- ğŸŒŸ åŒæ­¥æ˜¾ç¤ºè¯„è®ºè€…çš„çœŸå®æ˜µç§° -->
                                <div style="color:var(--magic-blue); font-weight:bold; font-size:15px; margin-bottom:5px;">
                                    {{ c.user_nickname || 'é­”æ³•å­¦å¾’' }}
                                    <el-tag v-if="c.user_id == videoInfo.author_id" size="small" type="danger" style="margin-left:10px; zoom:0.8">å‘å¸ƒè€…</el-tag>
                                </div>
                                <div style="color:#333; font-size:16px; line-height:1.6">{{ c.content }}</div>
                                <div style="color:#aaa; font-size:12px; margin-top:10px;">{{ c.create_date }}</div>
                            </div>
                        </div>
                        
                        <!-- æ— è¯„è®ºæ—¶çš„å ä½ -->
                        <div v-if="comments.length === 0" style="text-align:center; color:#999; padding:60px;">
                            <el-icon size="40" style="opacity:0.3"><ChatDotRound /></el-icon>
                            <p>è¿˜æ²¡æœ‰äººç•™ä¸‹å’’è¯­ï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</p>
                        </div>
                    </div>
                </div>
            </div>
        `,
        setup() {
            const route = useRoute();
            const router = useRouter();
            const videoInfo = reactive(route.query);
            const loading = ref(false);
            const isLiked = ref(videoInfo.is_favorite === 'true' || videoInfo.is_favorite === true);
            const cmtText = ref('');
            const comments = ref([]);
            const upInfo = ref({}); // å‘å¸ƒè€…èµ„æ–™
            const vPlayer = ref(null);
            const levels = ref([]);
            const currentLevel = ref(-1);
            const currentLevelName = ref('è‡ªåŠ¨');
            
            const currentUID = localStorage.getItem('user_id');
            const currentAccountAvatar = ref('https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png');
            const isAuthor = ref(currentUID == videoInfo.author_id);

            // HLS æ’­æ”¾é€»è¾‘
            onMounted(() => {
                if (Hls.isSupported() && videoInfo.play_url.endsWith('.m3u8')) {
                    const hls = new Hls();
                    hls.loadSource(videoInfo.play_url);
                    hls.attachMedia(vPlayer.value);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                        // è§£ææ¸…æ™°åº¦
                        if(data.levels.length > 1) {
                            levels.value = data.levels.map((l, idx) => ({
                                index: idx,
                                name: l.height + 'P',
                                height: l.height
                            }));
                            levels.value.unshift({ index: -1, name: 'è‡ªåŠ¨' });
                        }
                    });
                    
                    // æš´éœ²ç»™åˆ‡æ¢å‡½æ•°ä½¿ç”¨
                    window.hlsInstance = hls;
                } else {
                    vPlayer.value.src = videoInfo.play_url;
                }
                
                fetchUploader();
                fetchCmt();
                checkLikeStatus();
                // è·å–å½“å‰ç™»å½•è€…çš„å¤´åƒç”¨äºè¯„è®ºæ¡†
                if(currentUID) {
                    axios.get(`${API_BASE}/user/info?user_id=${currentUID}`).then(res => {
                        if(res.data.status_code === 0) currentAccountAvatar.value = res.data.user.avatar;
                    });
                }
            });

            // 1. è·å–å‘å¸ƒè€…ä¿¡æ¯
            const fetchUploader = async () => {
                try {
                    const res = await axios.get(`${API_BASE}/user/info?user_id=${videoInfo.author_id}`);
                    if(res.data.status_code === 0) {
                        upInfo.value = res.data.user;
                    }
                } catch(e) { console.error("è·å–å‘å¸ƒè€…å¤±è´¥", e); }
            };

            // 2. è·å–è¯„è®ºåˆ—è¡¨
            const fetchCmt = async () => {
                try {
                    const res = await axios.get(`${API_BASE}/comment/list?video_id=${videoInfo.id}`);
                    if (res.data.status_code === 0) {
                        comments.value = res.data.comment_list || [];
                    }
                } catch(e) { console.error("åŠ è½½è¯„è®ºå¤±è´¥", e); }
            };

            // 3. å‘å¸ƒè¯„è®º
            const postCmt = async () => {
                if(!cmtText.value.trim()) return ElementPlus.ElMessage.warning('å’’è¯­ä¸èƒ½ä¸ºç©º');
                if(!currentUID) return ElementPlus.ElMessage.error('è¯·å…ˆç­¾è®¢å¥‘çº¦ï¼ˆç™»å½•ï¼‰');

                try {
                    const url = `${API_BASE}/comment/action?video_id=${videoInfo.id}&comment_text=${encodeURIComponent(cmtText.value)}&user_id=${currentUID}&action_type=1`;
                    const res = await axios.post(url);
                    if(res.data.status_code === 0) {
                        cmtText.value = '';
                        fetchCmt(); // ç«‹å³åˆ·æ–°åˆ—è¡¨
                        ElementPlus.ElMessage.success('å’’è¯­å·²ä¼ è¾¾ï¼');
                    }
                } catch(e) { ElementPlus.ElMessage.error('æ–½æ³•ä¸­æ–­ï¼ˆå‘é€å¤±è´¥ï¼‰'); }
            };

            // 4. æ’¤å›è§†é¢‘ (åˆ é™¤)
            const doDel = () => {
                ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦æ’¤å›è¿™æ®µå½±åƒå—ï¼Ÿè¿™å°†ä»æ‰€æœ‰é­”æ³•ä½é¢æŠ¹é™¤ã€‚', 'è­¦å‘Š', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'ç‚¹é”™äº†',
                    type: 'warning'
                }).then(async () => {
                    try {
                        const res = await axios.post(`${API_BASE}/publish/delete?video_id=${videoInfo.id}&user_id=${currentUID}`);
                        if(res.data.status_code === 0) {
                            ElementPlus.ElMessage.success('å½±åƒå·²æˆåŠŸæ’¤å›');
                            router.push('/');
                        }
                    } catch(e) { ElementPlus.ElMessage.error('æ’¤å›å¤±è´¥ï¼Œé­”åŠ›å—é˜»'); }
                }).catch(() => {});
            };

            // 5. ç‚¹èµ
            const toggleLike = async () => {
                if(!currentUID) return ElementPlus.ElMessage.error('è¯·å…ˆç™»å½•');
                const action = isLiked.value ? 2 : 1;
                try {
                    await axios.post(`${API_BASE}/favorite/action?video_id=${videoInfo.id}&user_id=${currentUID}&action_type=${action}`);
                    isLiked.value = !isLiked.value;
                    ElementPlus.ElMessage.success(isLiked.value ? 'å¥‘çº¦å·²ç­¾è®¢ï¼' : 'å¥‘çº¦å·²è§£é™¤');
                } catch(e) {}
            };

            // 6. æ£€æŸ¥ç‚¹èµçŠ¶æ€
            const checkLikeStatus = async () => {
                if(!currentUID) return;
                try {
                    const res = await axios.get(`${API_BASE}/favorite/status?video_id=${videoInfo.id}&user_id=${currentUID}`);
                    if(res.data.status_code === 0) {
                        isLiked.value = res.data.is_favorite;
                    }
                } catch(e) {}
            };

            const changeQuality = (idx) => {
                if(window.hlsInstance) {
                    window.hlsInstance.currentLevel = idx;
                    currentLevel.value = idx;
                    const found = levels.value.find(l => l.index === idx);
                    if(found) currentLevelName.value = found.name;
                }
            };

            const formatDate = (s) => s ? new Date(s).toLocaleString() : '';

            // åˆå§‹åŒ–
            // onMounted(() => {
            //     fetchUploader();
            //     fetchCmt();
            //     // è·å–å½“å‰ç™»å½•è€…çš„å¤´åƒç”¨äºè¯„è®ºæ¡†
            //     if(currentUID) {
            //         axios.get(`${API_BASE}/user/info?user_id=${currentUID}`).then(res => {
            //             if(res.data.status_code === 0) currentAccountAvatar.value = res.data.user.avatar;
            //         });
            //     }
            // });

            return { 
                videoInfo, loading, isLiked, cmtText, comments, upInfo, vPlayer,
                isAuthor, currentAccountAvatar, postCmt, toggleLike, doDel, formatDate,
                levels, currentLevel, currentLevelName, changeQuality
            };
        }
    };

    const Upload = {
        template: `
            <div class="upload-container">
                <el-icon class="close-icon" @click="goHome"><CloseBold /></el-icon>
                <div style="font-family:'Ma Shan Zheng'; text-align:center; font-size:32px; margin-bottom:30px">å‘å¸ƒæ–°ä½œå“</div>
                <el-form label-position="top">
                    <el-form-item label="å½±åƒåç§°"><el-input v-model="title" size="large"></el-input></el-form-item>
                    <el-form-item label="é­”æ³•å°é¢ (16:9)">
                        <div class="cover-upload-box" @click="ck" :style="{ backgroundImage: pre ? 'url('+pre+')' : 'none' }">
                            <div v-if="!pre"><el-icon size="40"><Picture /></el-icon><div>ä¸Šä¼ å°é¢</div></div>
                        </div>
                        <input id="coverInp" type="file" @change="onCvrChg" style="display:none" accept="image/*">
                    </el-form-item>
                    <el-form-item label="å½±åƒæ–‡ä»¶"><input type="file" @change="e => f = e.target.files[0]" accept="video/*"></el-form-item>
                    <div style="display:flex; gap:20px; margin-top:30px;"><el-button size="large" style="flex:1" @click="goHome">æ”¾å¼ƒ</el-button><el-button type="primary" size="large" style="flex:2; background:var(--magic-pink); border:none; font-weight:bold; color:white;" @click="doUp" :loading="ing">æ–½æ³•å‘å¸ƒ</el-button></div>
                </el-form>
            </div>
        `,
        setup() {
            const title = ref(''); const f = ref(null); const pre = ref(null); const cf = ref(null); const ing = ref(false); const router = useRouter();
            const onCvrChg = (e) => { const file = e.target.files[0]; if(file){ cf.value=file; pre.value=URL.createObjectURL(file); } };
            const doUp = async () => {
                if(!title.value || !f.value) return;
                ing.value = true; const fd = new FormData(); fd.append('title', title.value); fd.append('data', f.value);
                fd.append('user_id', localStorage.getItem('user_id')); if(cf.value) fd.append('cover', cf.value);
                await axios.post(API_BASE+'/publish/action', fd); router.push('/');
            };
            return { title, f, pre, ing, goHome: () => router.push('/'), ck: () => document.getElementById('coverInp').click(), onCvrChg, doUp };
        }
    };

    const UploadNote = {
        template: `
            <div class="upload-container">
                <el-icon class="close-icon" @click="goHome"><CloseBold /></el-icon>
                <div style="font-family:'Ma Shan Zheng'; text-align:center; font-size:32px; margin-bottom:30px">å‘å¸ƒé­”æ³•ç¬”è®°</div>
                <el-form label-position="top">
                    <el-form-item label="ç¬”è®°æ ‡é¢˜"><el-input v-model="title" size="large"></el-input></el-form-item>
                    <el-form-item label="ç¬”è®°å†…å®¹"><el-input v-model="content" type="textarea" :rows="4"></el-input></el-form-item>
                    <el-form-item label="é­”æ³•å›¾ç‰‡">
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div v-for="(img, idx) in previews" :key="idx" style="width:100px; height:100px; border-radius:8px; overflow:hidden; position:relative;">
                                <img :src="img" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div class="cover-upload-box" style="width:100px; height:100px; aspect-ratio:1;" @click="ck">
                                <el-icon size="24"><Plus /></el-icon>
                            </div>
                        </div>
                        <input id="imgsInp" type="file" @change="onImgsChg" style="display:none" accept="image/*" multiple>
                    </el-form-item>
                    <div style="display:flex; gap:20px; margin-top:30px;">
                        <el-button size="large" style="flex:1" @click="goHome">æ”¾å¼ƒ</el-button>
                        <el-button type="primary" size="large" style="flex:2; background:var(--magic-blue); border:none; font-weight:bold; color:white;" @click="doUp" :loading="ing">å‘å¸ƒç¬”è®°</el-button>
                    </div>
                </el-form>
            </div>
        `,
        setup() {
            const title = ref(''); const content = ref(''); const files = ref([]); const previews = ref([]); const ing = ref(false); const router = useRouter();
            const onImgsChg = (e) => { 
                const fs = Array.from(e.target.files);
                files.value = [...files.value, ...fs];
                fs.forEach(f => previews.value.push(URL.createObjectURL(f)));
            };
            const doUp = async () => {
                if(!title.value || !content.value) return ElementPlus.ElMessage.warning('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º');
                ing.value = true; 
                const fd = new FormData(); 
                fd.append('title', title.value); 
                fd.append('content', content.value);
                fd.append('user_id', localStorage.getItem('user_id')); 
                files.value.forEach(f => fd.append('images', f));
                
                try {
                    const res = await axios.post(API_BASE+'/note/publish', fd);
                    if(res.data.status_code === 0) {
                        ElementPlus.ElMessage.success('ç¬”è®°å‘å¸ƒæˆåŠŸï¼');
                        router.push('/');
                    } else {
                        ElementPlus.ElMessage.error(res.data.status_msg);
                    }
                } catch(e) {
                    ElementPlus.ElMessage.error('å‘å¸ƒå¤±è´¥');
                } finally {
                    ing.value = false;
                }
            };
            return { title, content, previews, ing, goHome: () => router.push('/'), ck: () => document.getElementById('imgsInp').click(), onImgsChg, doUp };
        }
    };

    // ================= UserProfile ä¸ªäººä¸»é¡µ =================
    const UserProfile = {
        template: `
            <div class="detail-layout">
                <div class="glass-panel" style="text-align:center; padding:40px; margin-bottom:20px;">
                    <el-avatar :size="100" :src="user.avatar" style="border:4px solid white; box-shadow:0 5px 15px rgba(0,0,0,0.1)"></el-avatar>
                    <h2 style="margin:15px 0 5px; color:var(--text-title)">{{ user.nickname }}</h2>
                    <div style="color:#888; font-size:14px">ID: {{ user.id }}</div>
                </div>

                <div class="glass-panel" style="padding:20px">
                    <el-tabs v-model="activeTab">
                        <el-tab-pane label="æˆ‘çš„ä½œå“" name="works">
                            <div v-if="works.length > 0" class="video-grid">
                                <div class="video-card" v-for="item in works" :key="item.id" @click="goDetail(item)">
                                    <div class="card-cover">
                                        <img :src="item.cover_url">
                                        <div v-if="item.type==='note'" style="position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.6); color:#fff; padding:2px 6px; font-size:10px; border-radius:4px;">ç¬”è®°</div>
                                    </div>
                                    <div class="card-info">
                                        <div class="card-title">{{ item.title }}</div>
                                        <div style="margin-top:10px; text-align:right;">
                                            <el-button type="danger" size="small" icon="Delete" circle @click.stop="doDel(item)"></el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <el-empty v-else description="æš‚æ— ä½œå“"></el-empty>
                        </el-tab-pane>
                        <el-tab-pane label="æ¶ˆæ¯é€šçŸ¥" name="notifs">
                            <div v-if="notifs.length > 0">
                                <div v-for="(item, i) in notifs" :key="i" style="display:flex; align-items:center; padding:15px; border-bottom:1px solid #eee;">
                                    <el-avatar :size="50" :src="item.sender_avatar"></el-avatar>
                                    <div style="flex:1; margin-left:15px;">
                                        <div style="font-weight:bold; color:var(--magic-blue)">{{ item.sender_name }}</div>
                                        <div style="color:#333; font-size:15px; margin-top:5px;">
                                            <span v-if="item.action_type===1">èµäº†ä½ çš„{{ item.note_id > 0 ? 'ç¬”è®°' : 'ä½œå“' }}</span>
                                            <span v-else>è¯„è®ºäº†ï¼š{{ item.content }}</span>
                                        </div>
                                        <div style="color:#666; font-size:13px; margin-top:5px; background:#f9f9f9; padding:5px 10px; border-radius:4px; display:inline-block;">
                                            <span style="font-weight:bold;">ã€Š{{ item.target_title }}ã€‹</span>
                                        </div>
                                        <div style="color:#999; font-size:12px; margin-top:5px;">{{ item.created_at }}</div>
                                    </div>
                                    <img v-if="item.target_cover" :src="item.target_cover" style="width:80px; height:45px; object-fit:cover; border-radius:4px; margin-left:10px;">
                                </div>
                            </div>
                            <el-empty v-else description="æš‚æ— æ–°æ¶ˆæ¯"></el-empty>
                        </el-tab-pane>
                    </el-tabs>
                </div>
            </div>
        `,
        setup() {
            const user = ref({});
            const activeTab = ref('works');
            const works = ref([]);
            const notifs = ref([]);
            const router = useRouter();
            const myID = localStorage.getItem('user_id');

            const fetchWorks = async () => {
                const res = await axios.get(API_BASE + '/publish/list?user_id=' + myID);
                if(res.data.status_code === 0) works.value = res.data.video_list || [];
            };

            const fetchNotifs = async () => {
                const res = await axios.get(API_BASE + '/notification/list?user_id=' + myID);
                if(res.data.status_code === 0) notifs.value = res.data.list || [];
            };

            const doDel = (item) => {
                ElementPlus.ElMessageBox.confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ', 'æç¤º', { type: 'warning' }).then(async () => {
                    if (item.type === 'note') {
                        await axios.post(`${API_BASE}/note/delete?note_id=${item.id}&user_id=${myID}`);
                    } else {
                        await axios.post(`${API_BASE}/publish/delete?video_id=${item.id}&user_id=${myID}`);
                    }
                    ElementPlus.ElMessage.success('åˆ é™¤æˆåŠŸ');
                    fetchWorks();
                }).catch(() => {});
            };

            onMounted(() => {
                axios.get(`${API_BASE}/user/info?user_id=${myID}`).then(res => {
                    if(res.data.status_code === 0) user.value = res.data.user;
                });
                fetchWorks();
                fetchNotifs();
            });

            return { 
                user, activeTab, works, notifs, doDel,
                goDetail: (v) => router.push(v.type === 'note' ? { name: 'note', params: { id: v.id }, query: v } : { name: 'video', params: { id: v.id }, query: v })
            };
        }
    };

    const app = createApp({
        setup() {
            const router = useRouter(); const showAuth = ref(false); const authLoading = ref(false);
            const isLoggedIn = ref(!!localStorage.getItem('token'));
            const myInfo = reactive({ nickname: '', avatar: '' });
            const authF = reactive({ username: '', password: '', isLogin: true });
            const searchKw = ref('');

            const fetchMy = async () => { 
                if(isLoggedIn.value) { 
                    const res = await axios.get(`${API_BASE}/user/info?user_id=${localStorage.getItem('user_id')}`); 
                    if(res.data.status_code===0) {
                        Object.assign(myInfo, res.data.user);
                        if(res.data.user.background_image) {
                            document.body.style.backgroundImage = `url('${res.data.user.background_image}')`;
                        }
                    } 
                } 
            };
            const doA = async () => {
                authLoading.value = true; const p = authF.isLogin ? '/user/login' : '/user/register';
                try {
                    const res = await axios.post(`${API_BASE}${p}?username=${authF.username}&password=${authF.password}`);
                    if (res.data.status_code === 0) {
                        localStorage.setItem('token', res.data.token); localStorage.setItem('user_id', res.data.user_id);
                        location.reload();
                    } else { ElementPlus.ElMessage.error(res.data.status_msg); }
                } catch(e){} finally { authLoading.value = false; }
            };
            const uploadAvatar = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                const fd = new FormData(); fd.append('avatar', file); fd.append('user_id', localStorage.getItem('user_id'));
                const res = await axios.post(API_BASE+'/user/update_avatar', fd);
                if(res.data.status_code===0) { myInfo.avatar = res.data.avatar_url; ElementPlus.ElMessage.success('é­”æ³•å½¢è±¡å·²æ›´æ–°'); }
            };

            const doSearch = () => {
                if(searchKw.value) router.push('/?keyword=' + searchKw.value);
                else router.push('/');
            };

            const changeBg = async (e) => {
                const f = e.target.files[0]; 
                if(f){
                    const r = new FileReader(); 
                    r.onload=(ev)=>document.body.style.backgroundImage="url('"+ev.target.result+"')"; 
                    r.readAsDataURL(f);
                    
                    if(isLoggedIn.value) {
                        const fd = new FormData();
                        fd.append('background', f);
                        fd.append('user_id', localStorage.getItem('user_id'));
                        try {
                            await axios.post(API_BASE+'/user/update_background', fd);
                            ElementPlus.ElMessage.success('èƒŒæ™¯å·²åŒæ­¥è‡³é­”æ³•å¥‘çº¦');
                        } catch(e) { ElementPlus.ElMessage.warning('èƒŒæ™¯ä»…æœ¬åœ°ç”Ÿæ•ˆ(ä¿å­˜å¤±è´¥)'); }
                    }
                }
            };

            onMounted(fetchMy);
            return { showAuth, authLoading, isLoggedIn, authF, doA, myInfo, uploadAvatar, searchKw, doSearch, tBg: () => document.getElementById('bgInput').click(), cBg: changeBg, goHome: () => router.push('/'), goUpload: () => router.push('/upload'), goNoteUpload: () => router.push('/upload_note'), hCmd: (c) => {if(c==='logout'){localStorage.clear();location.reload();} else if(c==='changeAvatar'){document.getElementById('avatarInput').click();} else if(c==='goProfile'){router.push('/profile');}} };
        }
    });

    const routes = [ 
        { path: '/', component: Home }, 
        { path: '/profile', component: UserProfile },
        { path: '/video/:id', name: 'video', component: VideoDetail },
        { path: '/note/:id', name: 'note', component: NoteDetail },
        { path: '/upload', component: Upload }, 
        { path: '/upload_note', component: UploadNote } 
    ];
    const router = createRouter({ history: createWebHashHistory(), routes });
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component); }
    app.use(router); app.use(ElementPlus); app.mount('#app');
</script>
</body>
</html>